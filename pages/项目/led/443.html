<!DOCTYPE html>
<html lang="zh">
<head>
<title>FPGA之旅设计第五例-----IIC通信 - 知乎</title>
<meta charset="UTF-8">
</head>
<body>
<a role="pagedescription" aria-label="欢迎进入 FPGA之旅设计第五例-----IIC通信 - 知乎,盲人用户使用操作智能引导，请按快捷键Ctrl+Alt+R；阅读详细操作说明请按快捷键Ctrl+Alt+问号键。" aria-atomic="true" href="javascript:void(0)"></a><div><div><div></div><div></div><div><header role="banner"><div><a href="https://www.zhihu.com" aria-label="知乎"></a><div><div><nav><a href="https://www.zhihu.com/follow"><div>关注</div></a><a href="https://www.zhihu.com/"><div>推荐</div></a><a href="https://www.zhihu.com/hot"><div>热榜</div></a><a href="https://www.zhihu.com/column-square"><div>专栏</div></a><a href="https://www.zhihu.com/ring-feeds"><div>圈子<div>New</div></div></a><div></div><a href="https://www.zhihu.com/consult" target="_blank"><div>付费咨询</div></a><a href="https://www.zhihu.com/education/learning" target="_blank"><div>知学堂</div></a></nav><div><div role="search" data-za-module="PresetWordItem"><form><div><div><label><input type="text" maxlength="100" value="" autocomplete="off" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="AutoComplete2--1" aria-haspopup="true" placeholder=""><button aria-label="搜索" type="button"><span>​</span></button></label></div></div></form><a href="https://zhida.zhihu.com/" target="_blank">直答</a><div><div><button aria-label="创作" aria-haspopup="true" aria-expanded="false" type="button"></button></div></div></div></div><div><div><button href="https://www.zhihu.com/notifications" aria-label="63条通知" aria-haspopup="true" aria-expanded="false"><div>消息</div><div>63</div></button></div><div><button href="https://www.zhihu.com/messages" aria-label="21条私信" aria-haspopup="true" aria-expanded="false"><div>私信</div><div>21</div></button></div><a href="https://www.zhihu.com/creator" target="_blank"><div>创作中心</div></a></div></div><div><div><div><div><div><div><div><div><div>FPGA之旅设计第五例-----IIC通信</div></div><div><div><div><button aria-haspopup="true" aria-expanded="false" type="button"></button></div></div></div></div></div></div></div></div></div></div></div><div><div><button aria-haspopup="true" aria-expanded="false" type="button"><div></div></button></div><div><div aria-haspopup="true" aria-expanded="false"></div></div></div></div></header></div><div></div><div><span role="log" aria-live="assertive"></span></div><main role="main"><div data-zop-usertoken="{&quot;userToken&quot;:&quot;crash-kong&quot;}" data-zop="{&quot;authorName&quot;:&quot;FPGA之旅&quot;,&quot;itemId&quot;:&quot;555758226&quot;,&quot;title&quot;:&quot;FPGA之旅设计第五例-----IIC通信&quot;,&quot;type&quot;:&quot;article&quot;}" data-za-detail-view-path-module="PostItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;token&quot;:&quot;555758226&quot;,&quot;id&quot;:&quot;555758226&quot;}}}"><div></div><div><div></div></div><div><div><div><div><div><div><span><picture></picture></span></div></div></div><article tabindex="-1"><header><h1>FPGA之旅设计第五例-----IIC通信</h1><div><div itemprop="author" itemscope="" itemtype="http://schema.org/Person"><div><span><div><a href="//www.zhihu.com/people/wu-hui-peng-57" target="_blank" data-za-detail-view-element_name="User"></a></div></span><div><div><span><div><a href="//www.zhihu.com/people/wu-hui-peng-57" target="_blank" data-za-detail-view-element_name="User">FPGA之旅</a></div></span></div><div><div></div></div></div></div></div><button type="button"><span>​</span>关注她</button></div><div><div><div>2 人赞同了该文章</div></div></div><span></span></header><div><div><div><span><div options="[object Object]"><h2 data-first-child=""><b>一. 简介</b></h2><p data-pid="G3XSwaBP">这是FPGA之旅设计的第五例啦！今天给大家带来的是IIC通信，<span><a data-za-not-track-link="true" data-paste-text="true" href="https://zhida.zhihu.com/search?content_id=211634452&amp;content_type=Article&amp;match_order=1&amp;q=IIC%E5%8D%8F%E8%AE%AE&amp;zhida_source=entity" target="_blank">IIC协议</a></span>应用非常广泛，例如与MPU6050进行通信，配置OV5640摄像头、驱动OLED屏幕等等，都需要使用到IIC协议，所以掌握它是非常必要的，废话不多说，接着往下看。文末获取完整代码。</p><h2><b>二. IIC简介</b></h2><p data-pid="Hy9yPRvq">IIC协议分为主机和从机，所有的请求都是由主机发出，从机进行响应，从机是没有办法对主机进行读或写的。IIC协议共有两根线，数据线SDA和时钟线SCL，两根线就可以完成所以的通信请求，简直是太给力了。</p><h2><b>三. IIC协议</b></h2><p data-pid="YhX8i99p">终于到了IIC协议的部分。IIC协议简单来说，共有五种状态，这五种状态的有序组合就组成了完整的IIC通信，学习IIC协议，就是学习这五种状态。</p><ul><li data-pid="pEPZ5vkz"><b>空闲态</b>:     SCL 和 SDA 都为<span><a data-za-not-track-link="true" data-paste-text="true" href="https://zhida.zhihu.com/search?content_id=211634452&amp;content_type=Article&amp;match_order=1&amp;q=%E9%AB%98%E7%94%B5%E5%B9%B3&amp;zhida_source=entity" target="_blank">高电平</a></span>，不进行通信的时候。</li><li data-pid="sjVRdK33"><b>起始态</b>：  在SCL为高电平的时候，将SDA拉低，主机通知从机，开始进行通信。</li><li data-pid="iwWywr4N"><b>数据传输态</b>：数据传输态，又可以分为读和写两个部分，过程都是一样的，就合在一起了，都是在SCL为低电平的时候，SDA将数据发送，在SCL为高电平的时候，将数据接收。</li><li data-pid="dHoRWMNC"><b>(非)应答态</b>：数据传输态完成后，必须接一个应答态或者非应答态，为了确定对方接收到了数据。在SCL为高电平的时候，检测到SDA为低电平，则为应答，否则为非应答。</li><li data-pid="RcDhT6AB"><b>停止态</b>：一次数据传输完成，由主机发起，在SCL为高电平的时候，SDA由低电平变成高电平。</li></ul><p data-pid="87WtQJCG">了解了这五种状态后，接下来就要学习如何使用这五种状态来进行读写操作了。</p><h3><b>(一)  IIC写操作</b></h3><p data-pid="PVKlhRlQ">下面就是一个完整的写操作，共包含三次<span><a data-za-not-track-link="true" data-paste-text="true" href="https://zhida.zhihu.com/search?content_id=211634452&amp;content_type=Article&amp;match_order=5&amp;q=%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93&amp;zhida_source=entity" target="_blank">数据传输</a></span>态，第一次发送的是从机地址 + 0，第二次发送的是寄存器的地址，第三次写的是数据，写入寄存器中的数据。从机地址一般为7bit，与另外一bit共同组成8bit，<b>0表示写，1表示读</b>。</p><figure data-size="normal"><div></div></figure><figure data-size="normal"><div></div></figure><h3><b>（二）IIC读操作</b></h3><p data-pid="DU5K0f5X">读操作要比写操作复杂一点，需要的状态多一些。一共有五个数据传输态，<span><a data-za-not-track-link="true" data-paste-text="true" href="https://zhida.zhihu.com/search?content_id=211634452&amp;content_type=Article&amp;match_order=1&amp;q=%E7%8A%B6%E6%80%81%E5%9B%BE&amp;zhida_source=entity" target="_blank">状态图</a></span>如下了。</p><figure data-size="normal"><div></div></figure><figure data-size="normal"><div></div></figure><p data-pid="XjBRrhns">上面的流程图都是对从机的地址为7位以及从机的寄存器地址为8位的操作。</p><h2><b>四. Verilog代码实现</b></h2><p data-pid="rbKDQ6ee">有了上面的各个状态中，SDA和SCL的变换关系，以及读写的序列，就可以很方便的来写程序啦。</p><ol><li data-pid="jD4aM51x">首先，当然离不开<span><a data-za-not-track-link="true" data-paste-text="true" href="https://zhida.zhihu.com/search?content_id=211634452&amp;content_type=Article&amp;match_order=1&amp;q=%E7%8A%B6%E6%80%81%E6%9C%BA&amp;zhida_source=entity" target="_blank">状态机</a></span>，根据上面叙述的五种状态，编写状态机，状态机中，将数据传输态分成了读和写两种状态。有了各个状态，操作SDA和SCL两根线不是易如反掌嘛！</li></ol><div><pre><code>/*IIC 状态*/
localparam IIC_IDLE = 6'b000_001;  /*<span><a data-za-not-track-link="true" data-paste-text="true" href="https://zhida.zhihu.com/search?content_id=211634452&amp;content_type=Article&amp;match_order=2&amp;q=%E7%A9%BA%E9%97%B2%E6%80%81&amp;zhida_source=entity" target="_blank">空闲态</a></span>*/
localparam IIC_START = 6'b000_010;  /*起始态*/
localparam IIC_WRDATA = 6'b000_100;  /*写数据态*/
localparam IIC_RDDATA = 6'b001_000;  /*读数据态*/
localparam IIC_ACK = 6'b010_000;  /*应答态*/
localparam IIC_STOP = 6'b100_000;  /*停止态*/</code></pre></div><ol><li data-pid="fKCbYPzB">状态机的跳转条件如下，跳转条件和上面叙述的一样。单独看这个有点难懂，有些变量不明白其具体含义，可以结和仿真图形和完整代码进行理解。</li></ol><div><pre><code>/*状态机*/
always @(*)
begin
 case(state)
 IIC_IDLE: 
 if(IICWriteReq == 1'b1 || IICReadReq == 1'b1)
 next_state &lt;= IIC_START;
 else
 next_state &lt;= IIC_IDLE;
 IIC_START:
 if(IICCnt == (IIC_Pre * 'd2))
 next_state &lt;= IIC_WRDATA;
 else
 next_state &lt;= IIC_START;
 IIC_WRDATA:
 if(IICBitCnt == 'd8 &amp;&amp; IICCnt == IIC_Pre /4 &amp;&amp; iicCLK == 1'b0)
 next_state &lt;= IIC_ACK;
 else
 next_state &lt;= IIC_WRDATA;
 IIC_RDDATA:
 if(IICBitCnt == 'd8 &amp;&amp; IICCnt == IIC_Pre /4 &amp;&amp; iicCLK == 1'b0)
 next_state &lt;= IIC_ACK;
 else
 next_state &lt;= IIC_RDDATA;
 IIC_ACK:
 if(IICACKStopCnt == 'd1 &amp;&amp; IICCnt == IIC_Pre /4 &amp;&amp; iicCLK == 1'b0)
 if(IICSendBytes == 'd3) 
 if(IICWriteReq == 1'b1) /*三个字节发送完成，进入停止态*/
 next_state &lt;= IIC_STOP;
 else 
 next_state &lt;= IIC_RDDATA;
 else if(IICSendBytes == 'd2 &amp;&amp; IICReadReq == 1'b1)
 next_state &lt;= IIC_START;
 else if(IICSendBytes == 'd4)
 next_state &lt;= IIC_STOP;
 else
 next_state &lt;= IIC_WRDATA;
 else
 next_state &lt;= IIC_ACK;
 IIC_STOP:
 if(IICACKStopCnt == 'd1 &amp;&amp; IICCnt == IIC_Pre/4 &amp;&amp; iicCLK == 1'b1)
 next_state &lt;= IIC_IDLE;
 else
 next_state &lt;= IIC_STOP;
 default:  next_state &lt;= IIC_IDLE;
 endcase
end
</code></pre></div><h2>各个部分实现的详细代码，就不列举出来啦，代码总计280多行，也不算多。通过本IIC模块，可以驱动OV5640摄像头，MPU6050模块和0.96寸OLED屏幕等等，后续会基于此模块，来驱动这些外设。</h2><h2><b>五. testbeach编写</b></h2><p data-pid="-bw8DY3p">还是按照流程走，编写完模块后，进行一下仿真，还真有错误，幸亏仿真了，哈哈哈。</p><div><pre><code><span>`timescale</span><span>1</span><span>ns</span><span>/</span><span>1</span><span>ps</span><span>​</span><span>module</span><span>testbench</span><span>();</span><span>​</span><span>reg</span><span>clk</span><span>;</span><span>reg</span><span>rst</span><span>;</span><span>wire</span><span>SDA</span><span>;</span><span>wire</span><span>SCL</span><span>;</span><span>reg</span><span>IICWriteReq</span><span>;</span><span>reg</span><span>IICReadReq</span><span>;</span><span>wire</span><span>IICWriteDone</span><span>;</span><span>wire</span><span>IICReadDone</span><span>;</span><span>always</span><span>#</span><span>50</span><span>clk</span><span>=</span><span>~</span><span>clk</span><span>;</span><span>initial</span><span>begin</span><span>clk</span><span>=</span><span>1</span><span>'b1</span><span>;</span><span>rst</span><span>=</span><span>1</span><span>'b1</span><span>;</span><span>​</span><span>IICWriteReq</span><span>=</span><span>1</span><span>'b0</span><span>;</span><span>IICReadReq</span><span>=</span><span>1</span><span>'b1</span><span>;</span><span>#</span><span>100</span><span>/*手动复位*/</span><span>rst</span><span>=</span><span>1</span><span>'b0</span><span>;</span><span>#</span><span>100</span><span>rst</span><span>=</span><span>1</span><span>'b1</span><span>;</span><span>end</span><span>always</span><span>@(</span><span>posedge</span><span>clk</span><span>)</span><span>if</span><span>(</span><span>IICReadDone</span><span>==</span><span>1</span><span>'b1</span><span>)</span><span>/*读完成后，readReq为0，只进行一次读写操作*/</span><span>IICReadReq</span><span>&lt;=</span><span>1</span><span>'b0</span><span>;</span><span>else</span><span>IICReadReq</span><span>&lt;=</span><span>IICReadReq</span><span>;</span><span>​</span><span>IIC_Driver</span><span>IIC_DriverHP</span><span>(</span><span>.</span><span>sys_clk</span><span>(</span><span>clk</span><span>),</span><span>/*系统时钟*/</span><span>.</span><span>rst_n</span><span>(</span><span>rst</span><span>),</span><span>/*系统复位*/</span><span>​</span><span>.</span><span>IICSCL</span><span>(</span><span>SCL</span><span>),</span><span>/*IIC 时钟输出*/</span><span>.</span><span>IICSDA</span><span>(</span><span>SDA</span><span>),</span><span>/*IIC 数据线*/</span><span>​</span><span>.</span><span>IICSlave</span><span>(</span><span>'h1234</span><span>),</span><span>​</span><span>.</span><span>IICWriteReq</span><span>(</span><span>IICWriteReq</span><span>),</span><span>/*IIC写寄存器请求*/</span><span>.</span><span>IICWriteDone</span><span>(</span><span>IICWriteDone</span><span>),</span><span>/*IIC写寄存器完成*/</span><span>.</span><span>IICWriteData</span><span>(</span><span>'h5a</span><span>),</span><span>/*IIC发送数据 8bit的从机地址 + 8bit的寄存器地址 + 8bit的数据(读忽略，后默认为0)*/</span><span>​</span><span>.</span><span>IICReadReq</span><span>(</span><span>IICReadReq</span><span>),</span><span>/*IIC读寄存器请求*/</span><span>.</span><span>IICReadDone</span><span>(</span><span>IICReadDone</span><span>),</span><span>/*IIC读寄存器完成*/</span><span>.</span><span>IICReadData</span><span>()</span><span>/*IIC读取数据*/</span><span>);</span><span>​</span><span>endmodule</span></code></pre></div><p data-pid="RPJQkpR2">需要完整代码的可以关注微信公众号 <b>FPGA之旅</b> 回复 ：<b>FPGA之旅设计99例之第五例</b></p></div><span></span></span></div></div></div><div role="button" tabindex="0">发布于 2022-08-19 22:23</div><div><div><div data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;20774483&quot;}}}"><span><a href="//www.zhihu.com/topic/20774483" target="_blank"><div>FPGA开发工程师</div></a></span></div><div data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;20658465&quot;}}}"><span><a href="//www.zhihu.com/topic/20658465" target="_blank"><div>IIC</div></a></span></div><div data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;23667786&quot;}}}"><span><a href="//www.zhihu.com/topic/23667786" target="_blank"><div>FPGA开发</div></a></span></div></div></div><div><div><div data-za-detail-view-path-module="BottomBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;555758226&quot;,&quot;token&quot;:&quot;555758226&quot;}}}"><span><span><button aria-label="赞同 2 " aria-live="polite" type="button"><span>​</span>赞同 2</button></span><button aria-label="反对" aria-live="polite" type="button"><span>​</span></button></span><button type="button"><span>​</span>2 条评论</button><div><div aria-haspopup="true" aria-expanded="false"><button type="button"><span>​</span>分享</button></div></div><button aria-live="polite" type="button"><span>​</span>喜欢</button><button type="button"><span>​</span>收藏</button><button type="button"><span>​</span>申请转载</button><div><div><div aria-haspopup="true" aria-expanded="false"><button type="button"><span>​</span></button></div></div></div></div></div><div></div></div></article><div data-za-detail-view-path-module="CommentList" data-za-extra-module="{}"><div><div><div><div><div><div><div><div><div><div><div><div>理性发言，友善互动</div></div><div><div aria-describedby="placeholder-68pup" contenteditable="true" spellcheck="true" tabindex="0" role="textbox"><div data-contents="true"><div data-block="true" data-editor="68pup" data-offset-key="1garn-0-0"><div data-offset-key="1garn-0-0"><span data-offset-key="1garn-0-0"><br data-text="true"></span></div></div></div></div></div></div></div><div></div><input multiple="" type="file" accept="image/webp,image/jpg,image/jpeg,image/png,image/gif"></div></div></div></div></div></div><div><div><div><div>2 条评论</div></div><div></div><div><div>默认</div><div>最新</div></div></div><div><div><div data-id="10268083624"><div><div><div><a href="https://www.zhihu.com/people/4a3ba6a230a9d1ef4129d6dd45952db2" target="_blank"></a></div></div><div><div><div><div><div><a href="https://www.zhihu.com/people/4a3ba6a230a9d1ef4129d6dd45952db2" target="_blank">澹台克己</a></div><div><div></div></div></div></div></div><div>应该状态机可以再加一个状态吧，写的有点复杂，头有点晕（狗头)</div><div><div><div><span>2022-08-29</span><span> · </span><span href="">广东</span></div></div><div><button type="button"><span>​</span>回复</button><button type="button"><span>​</span>1</button></div></div></div></div><div data-id="10267649876"><div><div><div><a href="https://www.zhihu.com/people/a3ff942c6a005fe0448efec43b3be1f3" target="_blank"></a></div></div><div><div><div><div><div><a href="https://www.zhihu.com/people/a3ff942c6a005fe0448efec43b3be1f3" target="_blank">FPGA之旅</a></div><div><div></div><span href="">作者</span></div></div></div></div><div>额，添加那个状态？</div><div><div><div><span>2022-08-29</span><span> · </span><span href="">湖北</span></div></div><div><button type="button"><span>​</span>回复</button><button type="button"><span>​</span>喜欢</button></div></div></div></div></div></div><div></div></div></div></div></div></div></div></div></div><div><a aria-label="边栏锚点" aria-keyshortcuts="Shift+S"></a><div></div><div><div role="complementary" aria-label="关于作者"><div><div>关于作者</div></div><div><div><div><span><a href="//www.zhihu.com/people/wu-hui-peng-57" target="_blank" data-za-detail-view-element_name="User"></a></span></div><div><div><span><a href="//www.zhihu.com/people/wu-hui-peng-57" target="_blank" data-za-detail-view-element_name="User">FPGA之旅</a></span></div></div></div></div><div></div><div><div><div><a preset="plain" href="//www.zhihu.com/people/wu-hui-peng-57/answers" data-za-detail-view-element_name="Answer"><div><div>回答</div><strong title="123">123</strong></div></a><a preset="plain" href="//www.zhihu.com/people/wu-hui-peng-57/posts" data-za-detail-view-element_name="Post"><div><div>文章</div><strong title="48">48</strong></div></a><a preset="plain" href="//www.zhihu.com/people/wu-hui-peng-57/followers" data-za-detail-view-element_name="Follower"><div><div>关注者</div><strong title="506">506</strong></div></a></div></div><div><button type="button"><span>​</span>关注她</button><button type="button"><span>​</span>发私信</button></div></div></div></div></div></div><div><div role="complementary" aria-label="推荐阅读"><h3>推荐阅读</h3><ul><button disabled="" data-za-detail-view-path-module="Unknown" data-za-detail-view-path-module_name="推荐阅读" data-za-extra-module="{}"></button><a href="https://zhuanlan.zhihu.com/p/387639789"><div><h1>FPGA开发流程---项目方案与FPGA设计方案</h1><div><span>森森Tec...</span><span>发表于可编程门阵...</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/353234556"><div><h1>FPGA/数字IC秋招笔试面试005——CDC跨时钟域处理【打两拍】【握手】【异步FIFO】【脉冲展宽】【指示信号】（2022届）</h1><div><span>FPGA探...</span><span>发表于2022届...</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/1900930312877356788"><div><h1>【超大规模集成电路】数字芯片设计多视角和全流程</h1><div><span>骑鹤下江南</span><span>发表于芯片物理设...</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/380587698"><div><h1>一天一个设计实例-FPGA和IIC</h1><div><span>OpenF...</span><span>发表于一天一个F...</span></div></div></a><button data-za-detail-view-path-module="Unknown" data-za-detail-view-path-module_name="推荐阅读" data-za-extra-module="{}"></button></ul></div></div></div></main><div role="complementary"><div><div><button data-tooltip="回到顶部" data-tooltip-position="left" data-tooltip-will-hide-on-click="true" aria-label="回到顶部" type="button"></button></div></div></div></div></div><div><div><i>想来知乎工作？请发送邮件到 jobs@zhihu.com</i></div></div><div><div><div></div></div></div><div><div><div></div></div></div><div><div><div><div><div><label><input autocomplete="off" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="AutoComplete12-0" aria-haspopup="true" placeholder="选择语言" value=""></label></div></div></div></div></div><div></div>
</body>
</html>